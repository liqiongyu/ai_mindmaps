# MMA P0/P1/P2 执行清单（产品功能 + 交互细节 + 线框 + 文案 + 验收 + Spec + Backlog）

版本：v0.2（激活、可信与规模化）  
状态：Draft  
最后更新：2026-02-08  
关联文档：`docs/prd.md`

---

## 0. 目标、原则与分层

### 0.1 文档目标

把 MMA 从“功能可用”推进到“体验可信、增长可验证、工程可持续”。

本清单覆盖：

1. P0（必须）：激活、可控感、数据边界、基础质量
2. P1（增强）：效率、可靠性、可复盘、性能与测试体系
3. P2（扩展）：并发能力、增长与商业化、企业信任能力

### 0.2 优先级定义

- P0：不做会直接影响用户信任、核心转化、或造成明显体验断裂
- P1：不做不会阻塞上线，但会限制留存、口碑和迭代效率
- P2：面向规模化和商业化的中长期能力，不作为近期上线阻塞

### 0.3 建议节奏（可按团队容量调整）

- P0：2026-02-09 ～ 2026-03-06
- P1：2026-03-09 ～ 2026-04-17
- P2：2026-04-20 ～ 2026-06-12

### 0.4 North Star 与约束

North Star（7 日激活）：

- 完成一次“AI 改图 + 手工微调 + 导出/分享”的用户占比

核心约束（所有 PR 自检）：

1. AI 只通过 `operations[]` 改图，且可校验、可拒绝、可回滚
2. 首访用户应在 30-60 秒内进入可编辑画布并产出结果
3. 失败反馈必须非阻断、可理解、可恢复
4. 数据边界必须和用户心智一致（公开语义、隐私承诺）

---

## 1. P0（必须做）：激活 + 可信 + 基线质量

### P0-01 首次激活闭环（首页 -> 试玩 -> 登录导入）

#### 1) 产品功能和交互细节

- 首页 `/` 聚焦一件事：推进到 `/try`
- 试玩 `/try` 保持“可编辑 + 本地保存 + 清晰边界”
- 登录/注册后检测 `mma:try:draft:v1`，提供“导入草稿到云端”一次性引导
- 导入后自动进入新导图编辑页，避免用户再次手工重建

#### 2) 页面线框

```text
/（首页）
+----------------------------------------------------------------------------------+
| MindMaps AI                                 [立即体验（免登录）] 登录 [注册]     |
+----------------------------------------------------------------------------------+
| 对话生成“可控”的思维导图                                                         |
| ops 可校验、可撤销；先试玩，再决定是否注册。                                      |
| [立即体验（免登录）]  [登录继续]                                                 |
+----------------------------------------------------------------------------------+

/try -> /login 成功后
+-------------------------------------------------------------+
| 检测到你的试玩草稿（更新于 2 分钟前）                       |
| [导入到我的导图（推荐）] [继续从空白开始] [丢弃草稿]        |
+-------------------------------------------------------------+
```

#### 3) 文案和验收标准

文案：

- 首页主 CTA：`立即体验（免登录）`
- 试玩提示条：`你正在试玩本地草稿。登录后可使用 AI 与云端保存。`
- 导入弹窗标题：`检测到试玩草稿`
- 导入主按钮：`导入到我的导图（推荐）`

验收标准：

- [ ] 未登录用户 1 次点击进入 `/try`
- [ ] `/try` 刷新后草稿不丢
- [ ] 登录后若存在草稿，出现导入决策弹窗
- [ ] 导入成功后 3 秒内进入可编辑云端导图
- [ ] 埋点可计算 `首页 -> 试玩 -> 登录 -> 导入 -> 首次保存` 漏斗

#### 4) Spec

- 路由：
  - 新增 `POST /api/mindmaps/import-try`
- 请求：
  - `{ draft: MindmapState, ui?: MindmapUiState, source: "try" }`
- 响应：
  - `{ ok: true, mindmapId: string }`
- 导入后行为：
  - 清理本地 `mma:try:draft:v1`
- 埋点：
  - `landing_cta_click`
  - `try_opened`
  - `try_draft_detected_after_auth`
  - `try_draft_imported`

#### 5) Backlog

- `P0-01-FE-01` 首页 CTA 与层级校准
- `P0-01-FE-02` 试玩后登录导入弹窗 + 导入状态
- `P0-01-BE-01` 新增导入 API 与校验
- `P0-01-QA-01` E2E：试玩到导入云端

---

### P0-02 编辑器可访问与移动端可用性

#### 1) 产品功能和交互细节

- 持久化编辑模式下，移动端 AI 面板改为抽屉（而非固定侧栏）
- 画布节点支持键盘聚焦和键盘编辑，不依赖双击
- 全站按钮/链接/输入统一 `focus-visible` 风格
- 增加 Skip Link，保障键盘用户可快速进入主内容

#### 2) 页面线框

```text
/mindmaps/:id（移动端）
+---------------------------------------------------+
| MindMaps AI             [AI] [分享] [更多]        |
+---------------------------------------------------+
|                   画布（全屏）                    |
|                                                   |
+---------------------------------------------------+
| 底部抽屉（点 AI 打开）                            |
| [全局][节点]                                      |
| 对话流 ...                                        |
| 输入框 + 发送                                     |
+---------------------------------------------------+
```

#### 3) 文案和验收标准

文案：

- AI 按钮：`AI`
- 抽屉空态：`请选择一个节点以启用节点模式。`
- 键盘提示：`F2 编辑 · Enter 新增子节点 · Tab 新增同级`

验收标准：

- [ ] `<lg` 屏幕下画布可完整操作，不被固定侧栏压缩
- [ ] 节点可通过键盘聚焦、选中、进入编辑
- [ ] 所有主路径控件均有清晰 `focus-visible` 样式
- [ ] `Tab` 导航顺序合理，`Esc` 能关闭浮层/抽屉

#### 4) Spec

- 组件改造：
  - `MindmapChatSidebar` 支持 `desktop | drawer` 两种渲染模式
  - `MindmapCanvas` 节点支持 `role="button" + tabIndex={0}` 与键盘事件
- 可访问性：
  - `aria-live` 用于异步错误与保存状态
  - `layout.tsx` 增加 skip link：`跳转到主内容`

#### 5) Backlog

- `P0-02-FE-01` 移动端 AI 抽屉与开关
- `P0-02-FE-02` 画布节点键盘可达性
- `P0-02-FE-03` focus-visible 与 skip link 统一
- `P0-02-QA-01` 手动 + 自动可访问性检查（键盘流）

---

### P0-03 AI 可控感闭环（变更摘要 + 非阻断反馈）

#### 1) 产品功能和交互细节

- AI 每次应用 ops 后，显示统一的变更摘要
- 删除类操作在 UI 与文案上给出危险提示
- 把 `alert/confirm` 迁移为非阻断 toast/banner（保留关键危险二次确认弹窗）
- 所有错误有“发生了什么 + 怎么恢复”

#### 2) 页面线框

```text
AI 聊天区
------------------------------------------------
assistant: 已完成结构优化。
变更摘要：新增 4 · 改名 2 · 移动 1 · 删除 0
[查看 ops] [回滚到此条 AI 前]
------------------------------------------------
Toast（右上）
[保存失败] 网络超时，系统将在 5 秒后重试。 [立即重试]
```

#### 3) 文案和验收标准

文案：

- 摘要：`变更摘要：新增 {n} · 改名 {n} · 移动 {n} · 删除 {n}`
- 删除保护：`注意：删除属于危险操作，请确认影响范围。`
- 错误恢复：`应用失败：{message}。你可以重试，或回滚到上一步。`

验收标准：

- [ ] AI 应用成功后 2 秒内可见变更摘要
- [ ] 关键失败不再使用阻断式 `alert`
- [ ] 错误提示包含恢复路径（重试/回滚/联系客服）
- [ ] 异步错误可被屏幕阅读器读出（`aria-live`）

#### 4) Spec

- 新增前端反馈层：`uiFeedback.enqueue({ type, title, message, actions[] })`
- 错误分级：
  - `recoverable`：重试
  - `validation`：修改输入
  - `fatal`：回到列表或刷新
- AI 响应补充字段（可选）：
  - `changeSummary?: { add, rename, move, delete }`

#### 5) Backlog

- `P0-03-FE-01` 统一 toast/banner 组件
- `P0-03-FE-02` 替换编辑器和聊天中的 `alert`
- `P0-03-FE-03` AI 摘要展示统一化
- `P0-03-QA-01` 错误恢复路径回归测试

---

### P0-04 分享语义与公开数据边界

#### 1) 产品功能和交互细节

- 分享状态必须一眼可见：私有 / 公开（持链接可见）
- 支持：生成链接、刷新链接、停止分享
- 公开页明确“只读 + 不展示聊天”
- 修复公开数据边界：避免匿名枚举全部公开导图

#### 2) 页面线框

```text
编辑器分享条
+-------------------------------------------------------------------+
| 分享状态：公开（持链接可见，只读）                                 |
| https://.../public/slug                                           |
| [复制链接] [刷新链接] [停止分享]                                   |
| 公开页不会展示聊天记录与 AI ops。                                  |
+-------------------------------------------------------------------+
```

#### 3) 文案和验收标准

文案：

- 私有状态：`私有（仅我可见）`
- 公开状态：`公开（持链接可见，只读）`
- 停止分享确认：`停止分享后，旧链接将无法访问。继续？`

验收标准：

- [ ] 分享状态与操作在编辑页可见且语义明确
- [ ] 停止分享后旧链接不可访问
- [ ] 公开接口不暴露聊天数据
- [ ] 公开数据无法通过匿名列表接口被枚举

#### 4) Spec

- API：
  - `POST /api/mindmaps/:id/share`（生成/刷新）
  - `DELETE /api/mindmaps/:id/share`（停止分享）
- 数据访问策略：
  - 收紧 `public` RLS，改为仅允许通过受控 slug 路径读取
  - 优先方案：增加 `SECURITY DEFINER` RPC，按 slug 返回公开导图快照
- `GET /api/public/:slug` 响应最小化：
  - 返回渲染所需字段，不返回额外内部标识

#### 5) Backlog

- `P0-04-BE-01` 调整公开读取策略（RLS/RPC）
- `P0-04-BE-02` 公开 API 最小化响应
- `P0-04-FE-01` 分享状态与动作 UI 完整化
- `P0-04-QA-01` 安全回归（匿名访问边界）

---

### P0-05 保存原子性与持久化契约一致性

#### 1) 产品功能和交互细节

- 保存失败不能出现“部分写入成功”
- AI 返回成功必须和持久化状态一致（至少给出明确状态）
- 当某些持久化能力不可用时（如未迁移表），前端必须显式提示

#### 2) 页面线框

```text
状态区（编辑器顶部）
[已保存]
[保存中...]
[保存失败：节点数据未落库。已暂停自动重试。 [重试] [复制错误信息]]

AI 发送后
assistant: 已生成操作。
系统提示：改动已应用到画布，正在保存到云端...
```

#### 3) 文案和验收标准

文案：

- `保存失败：{message}（未完成云端持久化）`
- `聊天记录暂未持久化，刷新后可能丢失。`
- `视图状态暂未持久化，仅本次会话有效。`

验收标准：

- [ ] 保存路径在任何错误下保持原子（不出现半保存）
- [ ] 持久化不可用时，用户可见明确提示
- [ ] AI 改图后可明确区分“已应用”与“已保存”
- [ ] 节点 ID/结构校验在入口统一生效

#### 4) Spec

- 保存 API：仅保留原子 RPC 路径；移除逐行 upsert fallback
- `MindmapStateSchema` 收紧：`id/rootNodeId/parentId` 使用 UUID
- `GET /api/mindmaps/:id` 增加：
  - `persistence: { chat: boolean, uiState: boolean }`
- `POST /api/ai/chat` 响应可选：
  - `persistence: { chatPersisted: boolean }`

#### 5) Backlog

- `P0-05-BE-01` 移除非原子 fallback 保存路径
- `P0-05-BE-02` 增加 persistence 状态字段
- `P0-05-BE-03` 收紧 schema 与错误码
- `P0-05-QA-01` 注入失败场景测试（网络中断、RPC 缺失）

---

### P0-06 指标与观测最小闭环

#### 1) 产品功能和交互细节

- 用户关键动作全部可追踪
- API 核心路径有成功率与延迟指标
- 错误可追溯到具体链路和上下文

#### 2) 页面线框

```text
（内部仪表盘）
激活漏斗：/ -> /try -> 编辑 -> 导出/分享 -> 登录 -> 云端保存
保存健康：save_success_rate / p95_latency / retry_rate
AI 健康：chat_success_rate / scope_reject_rate / truncation_rate
```

#### 3) 文案和验收标准

文案：

- 后台告警文案：`保存失败率 > 2%（5分钟窗口）`
- 后台告警文案：`AI 截断率 > 5%（24小时）`

验收标准：

- [ ] 可按日查看激活漏斗转化
- [ ] 可定位保存失败高发阶段
- [ ] AI 失败可区分：校验失败、scope 越界、provider 错误

#### 4) Spec

核心事件：

- `editor_opened`
- `node_added`
- `ai_request_sent`
- `ai_ops_applied`
- `mindmap_saved`
- `export_succeeded`
- `share_link_generated`

API 指标：

- `/api/mindmaps/*`：`success_rate`, `p50/p95`, `error_code_distribution`
- `/api/ai/chat`：`success_rate`, `latency`, `invalid_output_rate`

#### 5) Backlog

- `P0-06-ENG-01` 事件 SDK 封装与统一埋点
- `P0-06-ENG-02` API 结构化日志
- `P0-06-ENG-03` 基础仪表盘与阈值告警
- `P0-06-QA-01` 埋点一致性校验

---

## 2. P1（增强）：效率、质量与可复盘

### P1-01 AI 控制台 2.0（预设、约束、高风险确认）

#### 1) 产品功能和交互细节

- Prompt chips 升级为“任务预设”（如会议纪要、学习计划、风险梳理）
- 约束改为可保存 preset（语言、深度、分支、是否允许移动/删除）
- 高影响变更（如删除节点总数超阈值）先预览再确认应用

#### 2) 页面线框

```text
AI 面板
[预设] 会议整理 | 学习拆解 | 风险评估
[约束] 语言:中文 深度:2 分支:6 删除:关闭
------------------------------------------------
预览变更：新增 8 · 删除 3（影响 12 节点）
[应用改动] [取消]
```

#### 3) 文案和验收标准

文案：

- `检测到高风险操作（删除影响 {n} 个节点），请确认后应用。`
- `已保存为“产品发布预设”。`

验收标准：

- [ ] 用户可创建/切换约束 preset
- [ ] 高风险操作必须经过确认
- [ ] 应用前可见摘要和影响规模

#### 4) Spec

- 新增表：`ai_constraint_presets`（owner_id, name, config）
- `POST /api/ai/chat` 支持：`dryRun: boolean`
- `dryRun=true` 返回仅预览，不落地

#### 5) Backlog

- `P1-01-FE-01` preset 管理 UI
- `P1-01-BE-01` preset CRUD API
- `P1-01-BE-02` chat dry-run 支持
- `P1-01-QA-01` 高风险确认链路 E2E

---

### P1-02 上下文瘦身与失败回退策略

#### 1) 产品功能和交互细节

- 大图按预算动态裁剪上下文
- 节点模式优先传子树与路径，而非全图
- 超限时返回可操作建议（而不是泛化 500）

#### 2) 页面线框

```text
AI 错误提示
上下文超出上限（当前 1800 行，建议 <= 800 行）
建议：
1) 切换节点模式
2) 降低深度到 1-2
3) 仅处理当前分支
```

#### 3) 文案和验收标准

文案：

- `导图过大，建议切换到节点模式以提高成功率。`
- `本次未应用改动：请缩小范围后重试。`

验收标准：

- [ ] 大图场景下 AI 请求成功率提升
- [ ] 错误文案提供明确下一步
- [ ] 截断/空输出率可被监控

#### 4) Spec

- `buildAiChatMindmapContext` 增加 token/行数预算模式
- `/api/ai/chat` 新增错误码：
  - `context_too_large`
  - `model_output_truncated`
  - `model_output_empty`

#### 5) Backlog

- `P1-02-BE-01` 动态上下文预算
- `P1-02-BE-02` 错误码标准化
- `P1-02-FE-01` 可操作错误提示模板
- `P1-02-QA-01` 大图压力测试

---

### P1-03 审计与回滚时间线

#### 1) 产品功能和交互细节

- 聊天消息可展开查看 ops
- 支持按消息回滚到指定快照点
- 支持导出某次会话的审计记录（JSON）

#### 2) 页面线框

```text
审计时间线
10:21 用户：扩展学习计划
10:22 AI：新增 6
      [查看 ops] [回滚到此条前]
10:24 用户：重组结构
10:25 AI：移动 4
      [查看 ops] [导出这次会话]
```

#### 3) 文案和验收标准

文案：

- `回滚已完成。可通过重做恢复。`
- `审计记录已导出。`

验收标准：

- [ ] 任意 AI 消息可回滚（受历史上限约束）
- [ ] ops 查看与复制稳定可用
- [ ] 导出审计记录可追溯 provider/model/time

#### 4) Spec

- 聊天消息模型补全：`createdAt/provider/model`
- 新增接口：`GET /api/ai/chat/export?mindmapId=...&scope=...`

#### 5) Backlog

- `P1-03-FE-01` 时间线视图优化
- `P1-03-BE-01` 审计导出 API
- `P1-03-QA-01` 回滚一致性回归

---

### P1-04 列表与画布性能优化

#### 1) 产品功能和交互细节

- 导图列表支持分页与搜索
- 大图编辑时减少不必要重排和重绘
- 公开页优先首屏可读

#### 2) 页面线框

```text
/ mindmaps
[搜索导图] [新建导图]
-------------------------------------------------
列表...
-------------------------------------------------
[上一页] 1 2 3 ... [下一页]
```

#### 3) 文案和验收标准

文案：

- `未找到匹配导图，试试其他关键词。`
- `已加载第 {page} 页，共 {total} 条。`

验收标准：

- [ ] 列表默认分页加载（避免全量拉取）
- [ ] 500+ 节点时编辑器仍可流畅操作
- [ ] 公开页首屏加载时间明显优化

#### 4) Spec

- `GET /api/mindmaps?cursor=&limit=&q=`
- 返回：`{ items, nextCursor, total }`

#### 5) Backlog

- `P1-04-BE-01` mindmaps 分页与搜索 API
- `P1-04-FE-01` 列表分页 UI
- `P1-04-FE-02` 画布性能 profiling 与优化
- `P1-04-QA-01` 大图性能基准测试

---

### P1-05 测试体系升级（API 集成 + 用户旅程 E2E）

#### 1) 产品功能和交互细节

- 用自动化测试保障关键用户旅程
- API 集成测试覆盖 CRUD、分享、AI 聊天核心分支
- E2E 覆盖从首访到产出完整路径

#### 2) 页面线框

```text
测试矩阵（内部）
- API integration: CRUD / Share / Chat / Save
- UI E2E: Landing -> Try -> Edit -> Export -> Share
- Reliability: save retry / AI invalid output / scope reject
```

#### 3) 文案和验收标准

文案：

- CI 失败提示：`核心旅程回归失败：{case_id}`

验收标准：

- [ ] 至少 1 条完整用户旅程 E2E
- [ ] API route 集成测试覆盖核心接口
- [ ] `vitest` 启用 coverage 与最低阈值

#### 4) Spec

- 新增测试目录：`src/app/api/**/*.test.ts`
- 覆盖率阈值（建议）：
  - `src/lib/mindmap/*` >= 90%
  - `src/lib/ai/*` >= 85%
  - `src/app/api/*` >= 75%

#### 5) Backlog

- `P1-05-QA-01` API 集成测试脚手架
- `P1-05-QA-02` 首条关键路径 E2E
- `P1-05-ENG-01` coverage 阈值接入 CI
- `P1-05-ENG-02` 失败截图/日志归档

---

## 3. P2（扩展）：规模化、增长与商业化

### P2-01 并发与版本冲突基础能力

#### 1) 产品功能和交互细节

- 引入 `mindmap_version`（或 `etag`）避免静默覆盖
- 冲突时给用户三选一：覆盖、拉取最新、另存副本

#### 2) 页面线框

```text
冲突弹窗
检测到该导图在其他会话已更新。
[覆盖保存（谨慎）] [加载最新] [另存为副本（推荐）]
```

#### 3) 文案和验收标准

文案：

- `检测到版本冲突，已阻止覆盖保存。`

验收标准：

- [ ] 并发保存不再静默丢数据
- [ ] 用户可明确选择冲突处理策略

#### 4) Spec

- `mindmaps.version bigint not null default 1`
- `POST /api/mindmaps/:id/save` 请求带 `baseVersion`
- 冲突返回 `409 conflict`

#### 5) Backlog

- `P2-01-BE-01` version 字段与保存校验
- `P2-01-FE-01` 冲突交互弹窗
- `P2-01-QA-01` 并发冲突测试

---

### P2-02 模板与场景化引导

#### 1) 产品功能和交互细节

- 提供模板库（学习、会议、项目、复盘）
- 新建导图时可选“空白/模板/AI 引导生成”

#### 2) 页面线框

```text
新建导图
[空白导图] [从模板创建] [AI 引导创建]
模板：学习计划 / 产品发布 / 风险评估 / 会议纪要
```

#### 3) 文案和验收标准

文案：

- `从模板开始，减少空白页焦虑。`

验收标准：

- [ ] 新建流程支持模板入口
- [ ] 模板创建后可直接编辑与 AI 扩展

#### 4) Spec

- 新增表：`mindmap_templates`
- 新增接口：`GET /api/templates`

#### 5) Backlog

- `P2-02-FE-01` 模板选择页
- `P2-02-BE-01` 模板数据与 API
- `P2-02-QA-01` 模板回归测试

---

### P2-03 公开页阅读体验 2.0

#### 1) 产品功能和交互细节

- 备注支持安全 Markdown 渲染
- 节点支持深链接（`?node=...`）
- 自动生成分享页 OG 图和摘要

#### 2) 页面线框

```text
/public/:slug
+--------------------------------------------------------------+
| 标题 + 更新时间 + 分享按钮                                  |
+--------------------------------------------------------------+
| 画布（只读）                  | 备注（Markdown）             |
|                               | 路径导航 / 节点目录          |
+--------------------------------------------------------------+
```

#### 3) 文案和验收标准

文案：

- `该节点暂无备注。`
- `复制当前节点链接`

验收标准：

- [ ] 公开页可读性明显提升（备注、路径、深链）
- [ ] 分享到社交平台有可识别预览卡片

#### 4) Spec

- 新增 `GET /api/public/:slug?nodeId=`
- metadata 支持 `og:image` 生成

#### 5) Backlog

- `P2-03-FE-01` 公开页 Markdown 渲染
- `P2-03-FE-02` 深链接跳转与高亮
- `P2-03-BE-01` OG 元信息生成

---

### P2-04 配额、成本与套餐基础

#### 1) 产品功能和交互细节

- 用户可见 AI 调用次数和导出/分享使用量
- 达到上限时有明确提示和升级路径

#### 2) 页面线框

```text
账户用量
AI 调用：72 / 100
公开分享：3 / 10
导出：15 / 50
[查看套餐] [升级]
```

#### 3) 文案和验收标准

文案：

- `本月 AI 调用已达上限，明日重置或升级套餐。`

验收标准：

- [ ] 用户可见核心用量指标
- [ ] 超额时有明确降级行为与升级路径

#### 4) Spec

- 新增表：`usage_counters`, `plan_limits`
- 请求链路注入配额检查中间层

#### 5) Backlog

- `P2-04-BE-01` 用量计数与限额规则
- `P2-04-FE-01` 用量面板
- `P2-04-OPS-01` 套餐配置与运营开关

---

### P2-05 企业信任包（合规与治理）

#### 1) 产品功能和交互细节

- 完整隐私政策与安全说明页
- 数据保留与删除策略可配置
- 审计日志支持导出

#### 2) 页面线框

```text
/ trust
隐私政策 | 安全实践 | 数据保留策略 | 审计导出
```

#### 3) 文案和验收标准

文案：

- `默认不将你的导图与对话用于模型训练。`
- `你可以随时删除数据与分享链接。`

验收标准：

- [ ] 隐私/安全页面可访问且内容完整
- [ ] 数据删除策略可执行、可验证

#### 4) Spec

- 新增页面：`/privacy`, `/security`, `/trust`
- 审计导出 API 与权限控制

#### 5) Backlog

- `P2-05-PM-01` 法务文案定稿
- `P2-05-FE-01` trust 页面落地
- `P2-05-BE-01` 审计导出接口

---

## 4. 文案字典（统一口径）

### 4.1 导航与 CTA

- `立即体验（免登录）`
- `登录继续`
- `注册并保存到云端`
- `回到我的导图`

### 4.2 编辑器工具栏

- `撤销` / `重做`
- `新增子节点` / `新增同级`
- `缩进` / `取消缩进`
- `上移` / `下移`
- `折叠` / `展开`
- `导出 PNG` / `导出 SVG`
- `分享`（`生成链接` / `刷新链接` / `停止分享`）

### 4.3 AI 与反馈

- `变更摘要：新增 {n} · 改名 {n} · 移动 {n} · 删除 {n}`
- `为安全起见，AI 默认不会删除节点。`
- `操作超出当前节点子树范围，已拒绝应用。`
- `保存失败：{message}（未完成云端持久化）`

### 4.4 空态与错误

- 导图列表空态：`还没有导图。新建一个开始吧。`
- 节点备注空态：`该节点暂无备注。`
- 通用错误：`操作失败：{message}`

---

## 5. Spec 汇总（跨优先级）

### 5.1 数据模型变更（建议）

| 阶段 | 变更                                | 目的                   |
| ---- | ----------------------------------- | ---------------------- |
| P0   | 收紧公开读取策略（RLS/RPC）         | 防止公开数据被枚举     |
| P0   | `MindmapStateSchema` 使用 UUID 约束 | 保证保存清理和引用可靠 |
| P1   | `ai_constraint_presets`             | 支持可复用 AI 约束     |
| P2   | `mindmaps.version`                  | 解决并发覆盖问题       |
| P2   | `usage_counters`/`plan_limits`      | 配额与商业化基础       |

### 5.2 API 变更（建议）

| 阶段 | API                                            | 说明                      |
| ---- | ---------------------------------------------- | ------------------------- |
| P0   | `POST /api/mindmaps/import-try`                | 登录后导入试玩草稿        |
| P0   | `GET /api/mindmaps/:id` 增 `persistence`       | 显示 chat/ui 持久化可用性 |
| P0   | `POST /api/ai/chat` 增 `persistence`（可选）   | 区分“已应用”与“已持久化”  |
| P1   | `POST /api/ai/chat` 支持 `dryRun`              | 高风险改动先预览          |
| P1   | `GET /api/mindmaps?cursor&limit&q`             | 列表分页与搜索            |
| P2   | `POST /api/mindmaps/:id/save` 带 `baseVersion` | 并发冲突保护              |

### 5.3 事件埋点（建议最小集）

| 事件                   | 触发时机      | 必填属性               |
| ---------------------- | ------------- | ---------------------- |
| `landing_cta_click`    | 点击首页 CTA  | `entry`, `cta`         |
| `try_opened`           | 进入 `/try`   | `source`               |
| `mindmap_edit_started` | 首次编辑节点  | `mode`                 |
| `ai_request_sent`      | 发送 AI 请求  | `scope`, `constraints` |
| `ai_ops_applied`       | ops 应用成功  | `summary`, `scope`     |
| `mindmap_saved`        | 保存成功      | `mode`, `latency_ms`   |
| `share_link_generated` | 生成/刷新链接 | `mindmap_id`           |
| `export_succeeded`     | 导出成功      | `format`               |

---

## 6. Backlog（可直接转 GitHub Issues）

建议 label：`prio/p0`、`prio/p1`、`prio/p2`、`area/frontend`、`area/backend`、`area/ai`、`area/infra`。

### 6.1 P0 Backlog

| ID    | Prio | Type  | 标题                       | Owner | 依赖  | 预估 | Issue                                                       |
| ----- | ---- | ----- | -------------------------- | ----- | ----- | ---- | ----------------------------------------------------------- |
| P0-01 | P0   | feat  | 首次激活闭环与试玩导入     | FE+BE | 无    | 4-6d | [#100](https://github.com/liqiongyu/ai_mindmaps/issues/100) |
| P0-02 | P0   | feat  | 编辑器移动端与可访问性改造 | FE    | P0-01 | 5-7d | [#101](https://github.com/liqiongyu/ai_mindmaps/issues/101) |
| P0-03 | P0   | feat  | AI 摘要与非阻断反馈系统    | FE    | 无    | 3-5d | [#102](https://github.com/liqiongyu/ai_mindmaps/issues/102) |
| P0-04 | P0   | fix   | 公开分享数据边界收紧       | BE    | 无    | 3-4d | [#103](https://github.com/liqiongyu/ai_mindmaps/issues/103) |
| P0-05 | P0   | fix   | 保存原子性与持久化契约     | BE    | P0-04 | 4-6d | [#104](https://github.com/liqiongyu/ai_mindmaps/issues/104) |
| P0-06 | P0   | chore | 埋点与可观测最小闭环       | FE+BE | P0-01 | 3-5d | [#105](https://github.com/liqiongyu/ai_mindmaps/issues/105) |

### 6.2 P1 Backlog

| ID    | Prio | Type  | 标题                              | Owner  | 依赖    | 预估 | Issue                                                       |
| ----- | ---- | ----- | --------------------------------- | ------ | ------- | ---- | ----------------------------------------------------------- |
| P1-01 | P1   | feat  | AI 控制台 2.0（preset + dry-run） | FE+BE  | P0-03   | 5-8d | [#106](https://github.com/liqiongyu/ai_mindmaps/issues/106) |
| P1-02 | P1   | feat  | 上下文瘦身与错误码标准化          | BE     | P0-05   | 4-6d | [#107](https://github.com/liqiongyu/ai_mindmaps/issues/107) |
| P1-03 | P1   | feat  | 审计时间线与会话导出              | FE+BE  | P0-03   | 4-6d | [#108](https://github.com/liqiongyu/ai_mindmaps/issues/108) |
| P1-04 | P1   | feat  | 列表分页搜索与画布性能优化        | FE+BE  | P0-06   | 5-8d | [#109](https://github.com/liqiongyu/ai_mindmaps/issues/109) |
| P1-05 | P1   | chore | API 集成测试 + 用户旅程 E2E       | QA+ENG | P0 全部 | 5-7d | [#110](https://github.com/liqiongyu/ai_mindmaps/issues/110) |

### 6.3 P2 Backlog

| ID    | Prio | Type | 标题                         | Owner    | 依赖  | 预估  | Issue                                                       |
| ----- | ---- | ---- | ---------------------------- | -------- | ----- | ----- | ----------------------------------------------------------- |
| P2-01 | P2   | feat | 版本冲突与并发保存保护       | FE+BE    | P1-05 | 5-8d  | [#111](https://github.com/liqiongyu/ai_mindmaps/issues/111) |
| P2-02 | P2   | feat | 模板库与场景化新建导图       | PM+FE+BE | P1-04 | 6-10d | [#112](https://github.com/liqiongyu/ai_mindmaps/issues/112) |
| P2-03 | P2   | feat | 公开页阅读体验 2.0           | FE+BE    | P0-04 | 4-7d  | [#113](https://github.com/liqiongyu/ai_mindmaps/issues/113) |
| P2-04 | P2   | feat | 配额与套餐基础能力           | BE+OPS   | P0-06 | 6-10d | [#114](https://github.com/liqiongyu/ai_mindmaps/issues/114) |
| P2-05 | P2   | feat | 企业信任包（隐私/安全/审计） | PM+FE+BE | P0-04 | 5-9d  | [#115](https://github.com/liqiongyu/ai_mindmaps/issues/115) |

---

## 7. 统一验收门槛（Definition of Done）

每个条目上线前必须满足：

1. 功能验收：满足对应条目验收标准
2. 交互验收：移动端 + 桌面端主路径可走通
3. 可访问性验收：键盘可达、focus-visible、关键状态 `aria-live`
4. 质量验收：`format/lint/typecheck/test` 全绿
5. 观测验收：关键事件已埋点，关键错误可定位
6. 回滚预案：数据与接口变更有回滚说明

---

## 8. Issue 模板（建议）

复制到每个 GitHub issue：

- Problem：用户痛点（1-3 句）
- Proposal：对应本清单条目
- UX：交互细节 + 文案
- Acceptance Criteria：勾选项
- Spec：接口/数据/埋点变更
- Risks：风险与回滚方案
